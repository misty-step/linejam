# Grooming Plan — 2026-02-23

## Themes Explored

- **Reliability Foundation:** React error boundaries + fail-fast env validation
- **Analytics + Viral Loop:** Viral funnel events, room code copy, Web Share API, post-game CTAs
- **Onboarding:** Homepage how-to-play, pre-game help access

## Not Explored (User-Deferred)

- **Security Hardening:** User did not select. However note: **CRITICAL prompt injection** — `previousLineText` is directly interpolated into the LLM prompt in `convex/lib/ai/providers/openrouter.ts`. Recommend creating this issue in the next session. Also: HTTP headers (#133), logShare auth (#134) already in current sprint.

## Issues Created

| #    | Title                                               | Score   | Labels                |
| ---- | --------------------------------------------------- | ------- | --------------------- |
| #168 | Add React error boundaries for room and page routes | P1/now  | p1, task, effort/s    |
| #169 | Fail-fast env var validation at Convex module load  | P2/next | p2, task, effort/s    |
| #170 | Add room code copy-to-clipboard button in Lobby     | P2/next | p2, feature, effort/s |
| #171 | Add viral funnel analytics events                   | P2/next | p2, task, effort/s    |
| #172 | Add Web Share API for native mobile sharing         | P2/next | p2, feature, effort/s |
| #173 | Add post-game action panel in RevealPhase           | P2/next | p2, feature, effort/m |
| #174 | Add How it works section to homepage                | P2/next | p2, feature, effort/s |
| #175 | Make HelpModal accessible on /host and /join        | P2/next | p2, task, effort/s    |

## Already In Progress (Current Sprint)

- #149 Fix animation quality across themes
- #148 Audit and fix theme token leakage
- #134 Add rate limit to logShare mutation
- #133 Add HTTP security headers
- #87 Memoize allStableIds and avatar color

## Already Queued (Next Sprint, Relevant)

- #146 Deduplicate getRevealPhaseState line fetches (covers N+1 finding)
- #84 Add rate limiting to remaining mutations (covers AI player rate limiting)

## Deferred

- **Prompt injection in AI generation** — CRITICAL security issue. `previousLineText` interpolated into LLM prompt without escaping. Create as P0 issue next session.
- **displayName Unicode sanitization** — MEDIUM. Control chars/RTL override possible.
- **Guest token issuedAt trust issue** — MEDIUM. Future-dated tokens extend lifetime.
- **Print-to-PDF for poems** — Nice-to-have, no urgency.
- **QR code for room code** — Deferred; copy-to-clipboard (#170) is MVP.
- **tune-repo artifacts** — No .glance.md files, no CODEBASE_MAP.md. Run `/tune-repo` to generate navigation artifacts.

## Research Findings Worth Preserving

- OG image for poem pages IS implemented (`app/poem/[id]/opengraph-image.tsx`) — the UX agent was wrong. Code is correct. Verify it's actually rendering in production at a shared poem URL.
- `useQuery` in Convex 1.x does not expose error state — errors become unhandled React exceptions. Error boundaries (#168) are the correct mitigation.
- Vercel Analytics `track()` is the only analytics provider — no PostHog, no Mixpanel. Keep it that way.
- `formatRoomCode()` exists in `lib/roomCode.ts` and formats "ABCD" → "AB CD".

---

_Generated by /groom session 2026-02-23_
